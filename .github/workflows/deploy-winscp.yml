name: Deploy with WinSCP

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
        
    - name: Restore and Publish
      run: |
        dotnet restore ./EgeControlWebApp/EgeControlWebApp.csproj
        dotnet publish ./EgeControlWebApp/EgeControlWebApp.csproj -c Release -o ./publish
        if (!(Test-Path -Path ./publish/logs)) { New-Item -ItemType Directory -Path ./publish/logs }
      
    - name: Install WinSCP
      run: |
        Invoke-WebRequest -Uri "https://winscp.net/download/files/WinSCP-6.1.2-Portable.zip" -OutFile "WinSCP.zip"
        Expand-Archive -Path "WinSCP.zip" -DestinationPath "WinSCP"
        
    - name: Deploy with WinSCP
      run: |
        $script = @"
        option batch abort
        option confirm off
        open ftp://${{ secrets.FTP_USERNAME }}:${{ secrets.FTP_PASSWORD }}@${{ secrets.FTP_SERVER }}
        option transfer binary
        lcd ./publish
        cd /httpdocs
        put app_offline.htm
        synchronize remote . . -delete -filemask="*.pdb;*.xml;app.db;logs/"
        rm app_offline.htm
        exit
        "@
        $script | Out-File -FilePath "deploy.txt" -Encoding UTF8
        ./WinSCP/WinSCP.com /script=deploy.txt
        
    - name: Cleanup
      run: |
        Remove-Item -Path "deploy.txt" -Force
        Remove-Item -Path "WinSCP" -Recurse -Force
        Remove-Item -Path "WinSCP.zip" -Force